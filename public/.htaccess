ServerSignature Off

<IfModule mod_mime.c>
      AddDefaultCharset UTF-8
      AddType text/plain .txt
      AddType "text/html; charset=UTF-8" .html .htm
      AddType "application/javascript; charset=UTF-8" .js
      AddType "text/css; charset=UTF-8" .css

      AddType image/jpeg .jpg .jpeg
      AddType image/png .png
      AddType image/gif .gif
      AddType image/svg+xml .svg
      AddType image/svg+xml .svgz
      AddType application/x-brotli .br
</IfModule>

<IfModule mod_headers.c>
      # Security Headers
      Header unset Server
      Header unset X-Powered-By
      Header set Content-Security-Policy "default-src 'self' 'unsafe-inline'; img-src * data:; style-src 'self' 'unsafe-inline' data:; style-src-elem 'self' 'unsafe-inline' data:; font-src 'self' data:; script-src-elem 'self' 'unsafe-inline' www.googletagmanager.com cdn.jsdelivr.net; connect-src 'self' https://api.ipify.org qcginwkfkawkktlmdiwa.supabase.co;"

      # ----------------------------------------------------------------------
      # | Compression / Pre-compressed files serving                          |
      # ----------------------------------------------------------------------
      <IfModule mod_rewrite.c>
            RewriteEngine On
            
            # 1. Rewrite www to non-www
            RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
            RewriteRule ^ http://%1%{REQUEST_URI} [L,R=301]

            # 2. SERVE BROTLI (Priority)
            # Check if browser accepts br AND if the .br file exists on disk
            RewriteCond "%{HTTP:Accept-encoding}" "br"
            RewriteCond "%{REQUEST_FILENAME}\.br" -s
            RewriteRule "^(.*)\.(css|js|html|svg)$" "$1\.$2\.br" [QSA,L]

            # 3. SERVE GZIP (Fallback)
            # Check if browser accepts gzip AND if the .gz file exists on disk
            RewriteCond "%{HTTP:Accept-encoding}" "gzip"
            RewriteCond "%{REQUEST_FILENAME}\.gz" -s
            RewriteRule "^(.*)\.(css|js|html|svg)$" "$1\.$2\.gz" [QSA,L]

            # 4. Set Content Types for Re-written files
            # Prevents Apache from serving them as "application/x-brotli" or "application/gzip"
            
            # Brotli Rules
            RewriteRule "\.css\.br$" "-" [T=text/css;charset=UTF-8,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.js\.br$"  "-" [T=text/javascript;charset=UTF-8,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.html\.br$" "-" [T=text/html;charset=UTF-8,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.svg\.br$"  "-" [T=image/svg+xml;charset=UTF-8,E=no-brotli:1,E=no-gzip:1]

            # Gzip Rules
            RewriteRule "\.css\.gz$" "-" [T=text/css;charset=UTF-8,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.js\.gz$"  "-" [T=text/javascript;charset=UTF-8,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.html\.gz$" "-" [T=text/html;charset=UTF-8,E=no-brotli:1,E=no-gzip:1]
            RewriteRule "\.svg\.gz$"  "-" [T=image/svg+xml;charset=UTF-8,E=no-brotli:1,E=no-gzip:1]
      </IfModule>

      # ----------------------------------------------------------------------
      # | Headers & Caching                                                  |
      # ----------------------------------------------------------------------

      # Set Content-Encoding header for Brotli files
      <FilesMatch "\.(js|css|html|svg)\.br$">
            Header append Content-Encoding br
            Header append Vary Accept-Encoding
      </FilesMatch>

      # Set Content-Encoding header for Gzip files
      <FilesMatch "\.(js|css|html|svg)\.gz$">
            Header append Content-Encoding gzip
            Header append Vary Accept-Encoding
      </FilesMatch>

      # Long Cache (1 Year) for immutable assets (images, fonts, bundles)
      # Added .br and .gz extensions here so the cache applies to the compressed versions too
      <FilesMatch "\.(jpg|jpeg|png|webp|ttf|svg|svg\.gz|svg\.br|js|js\.gz|js\.br|css|css\.gz|css\.br)$">
            Header append Cache-Control "public, max-age=31536000, immutable"
      </FilesMatch>

      # Short Cache / No Cache for HTML (Entry points)
      # You usually don't want to cache index.html long-term or users won't get updates
      <FilesMatch "\.(html|htm|html\.gz|html\.br)$">
            Header set Cache-Control "no-cache, must-revalidate"
      </FilesMatch>

      # Force UTF-8 for HTML
      # Note: I removed css|js from here because having Content-Type: text/html on a CSS file is bad practice
      <FilesMatch "\.(html|htm)$">
            Header set Content-Type "text/html; charset=UTF-8"
      </FilesMatch>
</IfModule>

# Redirect 404s to index.html (SPA Fallback)
ErrorDocument 404 /index.html